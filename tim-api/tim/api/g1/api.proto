syntax = "proto3";

import "google/protobuf/timestamp.proto";

package tim.api.g1;

message Timite {
  uint64 id = 1;
  string nick = 2;
}

message ClientInfo {
  string platform = 1;
}

message Session {
  string key = 1;  // secret
  uint64 timite_id = 2;
  google.protobuf.Timestamp created_at = 3;
  ClientInfo client_info = 4;
}

message Message {
  uint64 id = 1;
  uint64 sender_id = 2;
  string content = 3;
}

message Ability {
  string name = 1;
  string description = 2;
  repeated AbilityParameter params = 3;
}

message AbilityParameter {
  string name = 1;
  string description = 2;
}

message TimiteAbilities {
  Timite timite = 1;
  repeated Ability abilities = 2;
}

message CallAbility {
  uint64 timite_id = 1;
  uint64 sender_id = 2;
  string name = 3;
  string payload = 4;
  optional uint64 call_ability_id = 5;
}

message CallAbilityOutcome {
  uint64 call_ability_id = 1;
  optional string payload = 2;
  optional string error = 3;
}

message DeclareAbilitiesReq {
  repeated Ability abilities = 1;
}

message DeclareAbilitiesRes {
}

message ListAbilitiesReq {
  optional uint64 timite_id = 1;
}

message ListAbilitiesRes {
  repeated TimiteAbilities abilities = 1;
}

message SpaceEvent {
  message Metadata {
    uint64 id = 1;
    google.protobuf.Timestamp emitted_at = 2;
  }
  Metadata metadata = 1;
  oneof data {
    EventNewMessage event_new_message = 2;
    EventCallAbility event_call_ability = 3;
    EventCallAbilityOutcome event_call_ability_outcome = 4;
    EventTimiteConnected event_timite_connected = 5;
    EventTimiteDisconnected event_timite_disconnected = 6;
  }
}

message EventNewMessage {
  Message message = 1;
}

message EventCallAbility {
  CallAbility call_ability = 1;
}

message EventCallAbilityOutcome {
  CallAbilityOutcome call_ability_outcome = 1;
}

message EventTimiteConnected {
  Timite timite = 1;
}

message EventTimiteDisconnected {
  Timite timite = 1;
}

// --[ RPC req/res ]--

message Error {
  uint64 code = 1;
  string description = 2;
}

enum ErrorCode {
  ERROR_CODE_UNSPECIFIED = 0;
  ERROR_CODE_TIMITE_NOT_FOUND = 1;
}

message TrustedRegisterReq {
  string nick = 1;
  ClientInfo client_info = 2;
}

message TrustedRegisterRes {
  Session session = 1;
}

message TrustedConnectReq {
  Timite timite = 1;
  ClientInfo client_info = 2;
}

message TrustedConnectRes {
  Session session = 1;
  ErrorCode error = 2;
}

message SendMessageReq {
  string content = 2;
}

message SendMessageRes {
  optional Error error = 1;
}

message SubscribeToSpaceReq {
   bool receive_own_messages = 1;
}

message SendCallAbilityReq {
  CallAbility call_ability = 1;
}

message SendCallAbilityRes {
  uint64 call_ability_id = 1;
}

message SendCallAbilityOutcomeReq {
  CallAbilityOutcome outcome = 1;
}

message SendCallAbilityOutcomeRes {
}

message GetTimelineReq {
  uint64 offset = 1;
  uint32 size = 2;
}

message GetTimelineRes {
  uint64 offset = 1;
  uint32 size = 2;
  repeated SpaceEvent events = 3;
  repeated Timite timites = 4;
}

service TimGrpcApi {
  rpc TrustedRegister(TrustedRegisterReq) returns (TrustedRegisterRes);
  rpc TrustedConnect(TrustedConnectReq) returns (TrustedConnectRes);

  rpc SendMessage(SendMessageReq) returns (SendMessageRes);
  rpc SendCallAbility(SendCallAbilityReq) returns (SendCallAbilityRes);
  rpc SendCallAbilityOutcome(SendCallAbilityOutcomeReq) returns (SendCallAbilityOutcomeRes);
  rpc DeclareAbilities(DeclareAbilitiesReq) returns (DeclareAbilitiesRes);

  rpc ListAbilities(ListAbilitiesReq) returns (ListAbilitiesRes);
  rpc GetTimeline(GetTimelineReq) returns (GetTimelineRes);

  rpc SubscribeToSpace(SubscribeToSpaceReq) returns (stream SpaceEvent);
}
