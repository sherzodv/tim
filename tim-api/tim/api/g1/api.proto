syntax = "proto3";

import "google/protobuf/timestamp.proto";

package tim.api.g1;

message Timite {
  uint64 id = 1;
  string nick = 2;
}

message ClientInfo {
  string platform = 1;
}

message Session {
  string key = 1;  // secret
  uint64 timite_id = 2;
  google.protobuf.Timestamp created_at = 3;
  ClientInfo client_info = 4;
}

message Message {
  uint64 id = 1;
  uint64 sender_id = 2;
  string content = 3;
}

message Capability {
  string name = 1;
  string description = 2;
  repeated CapabilityParameter params = 3;
}

message CapabilityParameter {
  string name = 1;
  string description = 2;
}

message TimiteCapabilities {
  Timite timite = 1;
  repeated Capability capabilities = 2;
}

message DeclareCapabilitiesReq {
  repeated Capability capabilities = 1;
}

message DeclareCapabilitiesRes {
}

message ListCapabilitiesReq {
  optional uint64 timite_id = 1;
}

message ListCapabilitiesRes {
  repeated TimiteCapabilities capabilities = 1;
}

// --[ Updates: Space updates ]--

message SpaceUpdate {
  uint64 id = 1;
  oneof event {
    SpaceNewMessage space_new_message = 7;
  }
}

message SpaceNewMessage {
  Message message = 1;
}

// --[ RPC req/res ]--

message Error {
  uint64 code = 1;
  string description = 2;
}

message TrustedRegisterReq {
  string nick = 1;
  ClientInfo client_info = 2;
}

message TrustedRegisterRes {
  Session session = 1;
}

message TrustedConnectReq {
  Timite timite = 1;
  ClientInfo client_info = 2;
}

message TrustedConnectRes {
  Session session = 1;
}

message SendMessageReq {
  string content = 2;
}

message SendMessageRes {
  optional Error error = 1;
}

message SubscribeToSpaceReq {
   bool receive_own_messages = 1;
}

service TimGrpcApi {
  rpc TrustedRegister(TrustedRegisterReq) returns (TrustedRegisterRes);
  rpc TrustedConnect(TrustedConnectReq) returns (TrustedConnectRes);
  rpc SendMessage(SendMessageReq) returns (SendMessageRes);
  rpc SubscribeToSpace(SubscribeToSpaceReq) returns (stream SpaceUpdate);
  rpc DeclareCapabilities(DeclareCapabilitiesReq) returns (DeclareCapabilitiesRes);
  rpc ListCapabilities(ListCapabilitiesReq) returns (ListCapabilitiesRes);
}
